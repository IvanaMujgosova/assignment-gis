<!DOCTYPE html>
<html ng-app="nodeGeoData">
  <head>
    <title>London</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link rel="stylesheet" href="/stylesheets/style.css" media="screen">
    
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />
    <script src="//code.jquery.com/jquery-2.2.4.min.js" type="text/javascript"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.6/angular.min.js"></script>

  </head>

  <body ng-controller="mainController">

<div class="container navbar-right" style='width: 400px; height: 700px; '>
        <h3>Controller</h3>
        <p>Update values to change view</p>
        <ul class="nav nav-pills nav-stacked ">
          <li class="active"><a href="index.html">All food places</a><br>
            <form action="">
                    <input type="radio" name="point" value="a" checked="true" id="radioA" >Point A
                    <div class="form-group">
                        <label for="gpsA">Name:</label>
                        <input type="text" id="nameA">
                      </div><br>
                    <input type="radio" name="point" value="b" id="radioB"> Point B
                    <div class="form-group">
                        <label for="gpsB">Name:</label>
                        <input type="text" id="nameB"><br>
                      </div>
                  </form>
                  <button class="btn btn-primary" type="button"><a id="ShowLink" href="line.html">Show</a></button> 
        </li>
        <br>
          <li><a href="http://localhost:3000/pointsInArea.html?lng=-0.10685149067768407&lat=51.49627892557859&area=500">Find in area</a>
            <br>
        </li>
        <br>
          <li><a href="polygon.html">Show in London quarter</a></li>          
        </ul>
      </div>
       
    <div id='map' style='width: 1100px; height: 700px; '></div>
    <pre id='coordinates' class='coordinates'></pre>

    <script>
    var position;
    var map = null;

    var idA = 0;
    var idB = 0;

    addAllFoodPoints();
    

    function AddPointsToMap(data)
            {
                var result = [];
                data.forEach( geojson => {
                
                switch (geojson.amenity)
                {
                    case "restaurant": 
                        icon = "restaurant";
                        break;
                    case "cafe": 
                        icon = "cafe";
                        break;
                    case "fast-food": 
                        icon = "fast-food";
                        break;
                    case "pub": 
                        icon = "bar";
                        break;
                }

                var GPS = JSON.parse(geojson.st_asgeojson)

                result.push ({
                    "type": "Feature",
                    "geometry" : JSON.parse(geojson.st_asgeojson),
                    "properties": {
                        "name": geojson.name,
                        "icon": icon,
                        "description": "<strong>" + geojson.name + "</strong><p>" + geojson.amenity + " </p>",
                        "locationGeoJson" : geojson.st_asgeojson,
                        "id": geojson.osm_id
                    }              
                })
                });
                return result;
            };

    function addMap(data)
    {
        if (map != null) map.destroy();
        mapboxgl.accessToken = 'pk.eyJ1IjoibWlhODE1IiwiYSI6ImNqbXh6bmV5OTFwaGYzd3F5OGZzdjNzc3YifQ.MKspQIK7MTwBoa0ASsxBZg';
        map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/bright-v9',
        center: [-0.088,51.51], 
        zoom: 14
    });


    map.on('load', function () {
    
    map.addLayer({
        "id": "places",
        "type": "symbol",
        "source": {
            "type": "geojson",
            "data": {
                "type": "FeatureCollection",
                "features":
                AddPointsToMap(data)
            }
        },
        "layout": {
            "icon-image": "{icon}-15",
            "icon-allow-overlap": true
        }
    });
        // When a click event occurs on a feature in the places layer, open a popup at the
        // location of the feature, with description HTML from its properties.
        map.on('click', 'places', function (e) {
            var coordinates = e.features[0].geometry.coordinates.slice();
            var description = e.features[0].properties.description;

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            new mapboxgl.Popup()
                .setLngLat(coordinates)
                .setHTML(description)
                .addTo(map);
                
                if (document.getElementById("radioA").checked) {
                    document.getElementById("nameA").value = e.features[0].properties.name;
                    idA = e.features[0].properties.id;
                }

                if (document.getElementById("radioB").checked) {
                    document.getElementById("nameB").value = e.features[0].properties.name;
                    idB = e.features[0].properties.id;
                }

                var link = "line.html" + "?idA=" + idA + "&idB=" + idB;
                document.getElementById("ShowLink").href = link;
        });

        // Change the cursor to a pointer when the mouse is over the places layer.
        map.on('mouseenter', 'places', function () {
            map.getCanvas().style.cursor = 'pointer';
        });

        // Change it back to a pointer when it leaves.
        map.on('mouseleave', 'places', function () {
            map.getCanvas().style.cursor = '';
        });
    });
    
    }

    function addAllFoodPoints()
    {
    angular.module('nodeGeoData', [])
    .controller('mainController', ($scope, $http) => {
    $scope.formData = {};
    $scope.geoData = {};
    // Get all todos
    $http.get('/api/v1/geoData')
    .success((data) => {
        $scope.geoData = data;
        addMap(data);
    })
    .error((error) => {
        console.log('Error: ' + error);
    });
    });
    
}


    function addSomeFoodPoints()
    {

    angular.module('nodeGeoData', [])
    .controller('mainController', ($scope, $http) => {
    $scope.formData = {};
    $scope.geoData = {};
    // Get all todos
    $http.get('/api/v1/geoData')
    .success((data) => {
        $scope.geoData = data;
        console.log(data);
        addMap(data);
    })

    .error((error) => {
        console.log('Error: ' + error);
    });
    });
}
    </script>
  </body>
</html> 
